name: Release Check

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  release-readiness:
    name: Validate release readiness
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - name: Read crate metadata (head)
        id: head
        run: |
          echo "crate_name=$(.github/scripts/cargo-package-field.sh Cargo.toml name)" >> "$GITHUB_OUTPUT"
          echo "version=$(.github/scripts/cargo-package-field.sh Cargo.toml version)" >> "$GITHUB_OUTPUT"

      - name: Read base version
        id: base
        run: |
          BASE_REF="${{ github.base_ref || 'main' }}"
          git fetch --no-tags origin "${BASE_REF}:refs/remotes/origin/${BASE_REF}"
          git show "origin/${BASE_REF}:Cargo.toml" > /tmp/base-Cargo.toml
          echo "version=$(.github/scripts/cargo-package-field.sh /tmp/base-Cargo.toml version)" >> "$GITHUB_OUTPUT"

      - name: Validate semantic version bump
        env:
          BASE_VERSION: ${{ steps.base.outputs.version }}
          HEAD_VERSION: ${{ steps.head.outputs.version }}
        run: |
          echo "Base version: $BASE_VERSION"
          echo "Head version: $HEAD_VERSION"

          if [ "$BASE_VERSION" = "$HEAD_VERSION" ]; then
            echo "Version must be bumped in Cargo.toml for merges into main." >&2
            exit 1
          fi

          HIGHEST="$(printf '%s\n%s\n' "$BASE_VERSION" "$HEAD_VERSION" | sort -V | tail -n1)"
          if [ "$HIGHEST" != "$HEAD_VERSION" ]; then
            echo "Version must increase. Got $HEAD_VERSION <= $BASE_VERSION." >&2
            exit 1
          fi

      - name: Validate CHANGELOG entry for target version
        env:
          TARGET_VERSION: ${{ steps.head.outputs.version }}
        run: |
          if ! grep -Eq "^## \\[${TARGET_VERSION}\\] - [0-9]{4}-[0-9]{2}-[0-9]{2}$" CHANGELOG.md; then
            echo "CHANGELOG.md must contain a section header like:" >&2
            echo "## [${TARGET_VERSION}] - YYYY-MM-DD" >&2
            exit 1
          fi

      - name: Cargo publish dry-run
        run: cargo publish --dry-run --locked
